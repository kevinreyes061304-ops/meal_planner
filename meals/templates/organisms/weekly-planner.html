{% load meal_filters %}
{% comment %}
ORGANISM: Weekly Planner with Meal Suggestions
Description: 7-day meal planning grid with pre-populated existing data
{% endcomment %}

<div class="row">
    {% for date in week_dates %}
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header {% if date == today %}header-today{% else %}header-normal{% endif %}">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-calendar-day"></i>
                        {{ date|date:"l, F d" }}
                        {% if date == today %}<span class="badge bg-light text-dark ms-2">TODAY</span>{% endif %}
                    </h4>
                    <button type="button" class="btn btn-sm btn-danger" 
                            data-delete-date="{{ date|date:'Y-m-d' }}"
                            onclick="deleteDayMeals(this.dataset.deleteDate)" 
                            title="Clear all meals for this day">
                        <i class="fas fa-trash-alt"></i> Clear Day
                    </button>
                </div>
            </div>
            
            <div class="card-body">
                <div class="row">
                    <!-- ========== BREAKFAST SECTION ========== -->
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="p-3" style="background: #fff8e1; border-radius: 10px; border-left: 4px solid #ffd54f;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">
                                    <i class="fas fa-mug-hot" style="color: #ffd54f;"></i>
                                    Breakfast
                                </h6>
                                <div>
                                    <button type="button" class="btn btn-sm btn-warning me-1" 
                                            data-meal-type="breakfast" 
                                            data-date="{{ date|date:'Y-m-d' }}"
                                            onclick="showMealSuggestions(this)" 
                                            title="Get meal suggestions">
                                        <i class="fas fa-lightbulb"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                            data-delete-date="{{ date|date:'Y-m-d' }}"
                                            data-meal-type-delete="breakfast"
                                            onclick="deleteMeal(this.dataset.deleteDate, this.dataset.mealTypeDelete)" 
                                            title="Delete this meal">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            
                            {% with prefix=date|date:"Y-m-d"|add:"_breakfast" meal_key=date|date:"Y-m-d"|add:"|breakfast" %}
                            {% with current_meal=meals_dict|get_item:meal_key %}
                            <input type="hidden" name="{{ prefix }}-date" value="{{ date|date:'Y-m-d' }}">
                            <input type="hidden" name="{{ prefix }}-meal_type" value="breakfast">
                            
                            <div class="mb-2">
                                <select name="{{ prefix }}-recipe" class="form-control form-select">
                                    <option value="">-- Select Recipe --</option>
                                    {% for recipe in recipes %}
                                    <option value="{{ recipe.id }}" {% if current_meal.recipe_id == recipe.id %}selected{% endif %}>
                                        {% if recipe.created_by %}‚≠ê {% endif %}{{ recipe.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-2">
                                <input type="text" name="{{ prefix }}-custom_meal" class="form-control" placeholder=" " value="{{ current_meal.custom_meal }}">
                            </div>
                            
                            <div class="mb-0">
                                <textarea name="{{ prefix }}-notes" class="form-control" rows="1" placeholder="Notes...">{{ current_meal.notes }}</textarea>
                            </div>
                            {% endwith %}
                            {% endwith %}
                        </div>
                    </div>
                    
                    <!-- ========== LUNCH SECTION ========== -->
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="p-3" style="background: #fff3e0; border-radius: 10px; border-left: 4px solid #ff9800;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">
                                    <i class="fas fa-hamburger" style="color: #ff9800;"></i>
                                    Lunch
                                </h6>
                                <div>
                                    <button type="button" class="btn btn-sm btn-warning me-1" 
                                            data-meal-type="lunch" 
                                            data-date="{{ date|date:'Y-m-d' }}"
                                            onclick="showMealSuggestions(this)" 
                                            title="Get meal suggestions">
                                        <i class="fas fa-lightbulb"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                            data-delete-date="{{ date|date:'Y-m-d' }}"
                                            data-meal-type-delete="lunch"
                                            onclick="deleteMeal(this.dataset.deleteDate, this.dataset.mealTypeDelete)" 
                                            title="Delete this meal">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            
                            {% with prefix=date|date:"Y-m-d"|add:"_lunch" meal_key=date|date:"Y-m-d"|add:"|lunch" %}
                            {% with current_meal=meals_dict|get_item:meal_key %}
                            <input type="hidden" name="{{ prefix }}-date" value="{{ date|date:'Y-m-d' }}">
                            <input type="hidden" name="{{ prefix }}-meal_type" value="lunch">
                            
                            <div class="mb-2">
                                <select name="{{ prefix }}-recipe" class="form-control form-select">
                                    <option value="">Select a recipe...</option>
                                    {% for recipe in recipes %}
                                    <option value="{{ recipe.id }}" {% if current_meal.recipe_id == recipe.id %}selected{% endif %}>{{ recipe.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-2">
                                <input type="text" name="{{ prefix }}-custom_meal" class="form-control" placeholder=" " value="{{ current_meal.custom_meal }}">
                            </div>
                            
                            <div class="mb-0">
                                <textarea name="{{ prefix }}-notes" class="form-control" rows="1" placeholder="Notes...">{{ current_meal.notes }}</textarea>
                            </div>
                            {% endwith %}
                            {% endwith %}
                        </div>
                    </div>
                    
                    <!-- ========== DINNER SECTION ========== -->
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="p-3" style="background: #ffebee; border-radius: 10px; border-left: 4px solid #e57373;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">
                                    <i class="fas fa-drumstick-bite" style="color: #e57373;"></i>
                                    Dinner
                                </h6>
                                <div>
                                    <button type="button" class="btn btn-sm btn-danger me-1" 
                                            data-meal-type="dinner" 
                                            data-date="{{ date|date:'Y-m-d' }}"
                                            onclick="showMealSuggestions(this)" 
                                            title="Get meal suggestions">
                                        <i class="fas fa-lightbulb"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                            data-delete-date="{{ date|date:'Y-m-d' }}"
                                            data-meal-type-delete="dinner"
                                            onclick="deleteMeal(this.dataset.deleteDate, this.dataset.mealTypeDelete)" 
                                            title="Delete this meal">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            
                            {% with prefix=date|date:"Y-m-d"|add:"_dinner" meal_key=date|date:"Y-m-d"|add:"|dinner" %}
                            {% with current_meal=meals_dict|get_item:meal_key %}
                            <input type="hidden" name="{{ prefix }}-date" value="{{ date|date:'Y-m-d' }}">
                            <input type="hidden" name="{{ prefix }}-meal_type" value="dinner">
                            
                            <div class="mb-2">
                                <select name="{{ prefix }}-recipe" class="form-control form-select">
                                    <option value="">Select a recipe...</option>
                                    {% for recipe in recipes %}
                                    <option value="{{ recipe.id }}" {% if current_meal.recipe_id == recipe.id %}selected{% endif %}>{{ recipe.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-2">
                                <input type="text" name="{{ prefix }}-custom_meal" class="form-control" placeholder=" " value="{{ current_meal.custom_meal }}">
                            </div>
                            
                            <div class="mb-0">
                                <textarea name="{{ prefix }}-notes" class="form-control" rows="1" placeholder="Notes...">{{ current_meal.notes }}</textarea>
                            </div>
                            {% endwith %}
                            {% endwith %}
                        </div>
                    </div>
                    
                    <!-- ========== MIDNIGHT SNACK SECTION ========== -->
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="p-3" style="background: #f3e5f5; border-radius: 10px; border-left: 4px solid #9c27b0;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">
                                    <i class="fas fa-moon" style="color: #9c27b0;"></i>
                                    Midnight Snack
                                </h6>
                                <div>
                                    <button type="button" class="btn btn-sm btn-secondary me-1" 
                                            data-meal-type="midnight_snack" 
                                            data-date="{{ date|date:'Y-m-d' }}"
                                            onclick="showMealSuggestions(this)" 
                                            title="Get meal suggestions">
                                        <i class="fas fa-lightbulb"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                            data-delete-date="{{ date|date:'Y-m-d' }}"
                                            data-meal-type-delete="midnight_snack"
                                            onclick="deleteMeal(this.dataset.deleteDate, this.dataset.mealTypeDelete)" 
                                            title="Delete this meal">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            
                            {% with prefix=date|date:"Y-m-d"|add:"_midnight_snack" meal_key=date|date:"Y-m-d"|add:"|midnight_snack" %}
                            {% with current_meal=meals_dict|get_item:meal_key %}
                            <input type="hidden" name="{{ prefix }}-date" value="{{ date|date:'Y-m-d' }}">
                            <input type="hidden" name="{{ prefix }}-meal_type" value="midnight_snack">
                            
                            <div class="mb-2">
                                <select name="{{ prefix }}-recipe" class="form-control form-select">
                                    <option value="">Select a recipe...</option>
                                    {% for recipe in recipes %}
                                    <option value="{{ recipe.id }}" {% if current_meal.recipe_id == recipe.id %}selected{% endif %}>{{ recipe.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-2">
                                <input type="text" name="{{ prefix }}-custom_meal" class="form-control" placeholder=" " value="{{ current_meal.custom_meal }}">
                            </div>
                            
                            <div class="mb-0">
                                <textarea name="{{ prefix }}-notes" class="form-control" rows="1" placeholder="Notes...">{{ current_meal.notes }}</textarea>
                            </div>
                            {% endwith %}
                            {% endwith %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- ========================================== -->
<!-- MEAL SUGGESTIONS MODAL -->
<!-- ========================================== -->
<div class="modal fade" id="mealSuggestionsModal" tabindex="-1" aria-labelledby="mealSuggestionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-green) 0%, var(--dark-green) 100%); color: white;">
                <h5 class="modal-title" id="mealSuggestionsModalLabel">
                    <i class="fas fa-lightbulb"></i> <span id="mealTypeTitle">Meal</span> Suggestions
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="mealSuggestionsContent">
                <!-- Suggestions loaded here by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- JAVASCRIPT FOR MEAL SUGGESTIONS -->
<!-- ========================================== -->
<style>
.meal-suggestion-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.meal-suggestion-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
    border-color: var(--primary-green);
}

.meal-suggestion-card:active {
    transform: translateY(-2px);
}

.suggestion-emoji {
    font-size: 2.5rem;
    line-height: 1;
}

.suggestion-content {
    flex: 1;
}

.header-today {
    background: linear-gradient(135deg, #ff9800 0%, #ffa726 100%);
    color: white;
}

.header-normal {
    background: linear-gradient(135deg, var(--primary-green) 0%, var(--light-green) 100%);
    color: white;
}
</style>

<script>
// ========================================
// MEAL SUGGESTIONS DATABASE
// ========================================
const mealSuggestions = {
    breakfast: [
        { name: 'Coffee & Toast', emoji: '‚òï', description: 'Simple morning starter with caffeine boost' },
        { name: 'Pancakes', emoji: 'ü•û', description: 'Fluffy breakfast classic with syrup' },
        { name: 'Oatmeal', emoji: 'ü•£', description: 'Healthy and filling whole grain' },
        { name: 'Scrambled Eggs', emoji: 'üç≥', description: 'Protein-packed breakfast essential' },
        { name: 'Cereal & Milk', emoji: 'ü•õ', description: 'Quick and easy morning meal' },
        { name: 'French Toast', emoji: 'üçû', description: 'Sweet cinnamon-infused bread' },
        { name: 'Smoothie Bowl', emoji: 'üçì', description: 'Fresh fruits blended perfectly' },
        { name: 'Bacon & Eggs', emoji: 'ü•ì', description: 'Classic hearty American breakfast' },
        { name: 'Avocado Toast', emoji: 'ü•ë', description: 'Trendy and nutritious choice' },
        { name: 'Breakfast Burrito', emoji: 'üåØ', description: 'Wrapped morning goodness' },
        { name: 'Yogurt Parfait', emoji: 'üç®', description: 'Layered with granola and berries' },
        { name: 'Bagel & Cream Cheese', emoji: 'ü•Ø', description: 'Classic deli-style breakfast' }
    ],
    lunch: [
        { name: 'Sandwich', emoji: 'ü•™', description: 'Quick and portable classic' },
        { name: 'Salad Bowl', emoji: 'ü•ó', description: 'Healthy fresh vegetables' },
        { name: 'Pasta', emoji: 'üçù', description: 'Filling Italian favorite' },
        { name: 'Burger', emoji: 'üçî', description: 'Satisfying American classic' },
        { name: 'Soup', emoji: 'üç≤', description: 'Warm and comforting bowl' },
        { name: 'Tacos', emoji: 'üåÆ', description: 'Flavorful Mexican street food' },
        { name: 'Rice Bowl', emoji: 'üçö', description: 'Balanced Asian-inspired meal' },
        { name: 'Pizza Slice', emoji: 'üçï', description: 'Everyone\'s quick favorite' },
        { name: 'Wrap', emoji: 'üåØ', description: 'Rolled up goodness' },
        { name: 'Sushi Roll', emoji: 'üç£', description: 'Japanese delicacy' },
        { name: 'Quesadilla', emoji: 'üßÄ', description: 'Cheesy Mexican delight' },
        { name: 'Chicken Caesar', emoji: 'ü•ô', description: 'Classic salad with protein' }
    ],
    dinner: [
        { name: 'Steak', emoji: 'ü•©', description: 'Premium grilled beef cut' },
        { name: 'Grilled Chicken', emoji: 'üçó', description: 'Healthy lean protein' },
        { name: 'Fish Fillet', emoji: 'üêü', description: 'Light and nutritious seafood' },
        { name: 'Spaghetti Bolognese', emoji: 'üçù', description: 'Italian family favorite' },
        { name: 'Stir Fry', emoji: 'ü•ò', description: 'Quick Asian wok dish' },
        { name: 'Roast Dinner', emoji: 'üçñ', description: 'Traditional Sunday meal' },
        { name: 'Curry', emoji: 'üçõ', description: 'Spicy and aromatic dish' },
        { name: 'BBQ Ribs', emoji: 'üçñ', description: 'Finger-licking good meat' },
        { name: 'Lasagna', emoji: 'ü•ò', description: 'Layered Italian comfort food' },
        { name: 'Salmon', emoji: 'üê†', description: 'Omega-3 rich fish' },
        { name: 'Pork Chops', emoji: 'ü•©', description: 'Juicy tender meat' },
        { name: 'Meatballs', emoji: 'üçù', description: 'Savory ground meat balls' }
    ],
    midnight_snack: [
        { name: 'Cookies', emoji: 'üç™', description: 'Sweet baked treats' },
        { name: 'Fruit Cup', emoji: 'üçé', description: 'Healthy fresh option' },
        { name: 'Chips', emoji: 'ü•î', description: 'Crunchy salty snack' },
        { name: 'Ice Cream', emoji: 'üç¶', description: 'Cool creamy dessert' },
        { name: 'Popcorn', emoji: 'üçø', description: 'Light movie snack' },
        { name: 'Yogurt', emoji: 'ü•õ', description: 'Creamy and light' },
        { name: 'Nuts', emoji: 'ü•ú', description: 'Protein-rich snack' },
        { name: 'Cheese & Crackers', emoji: 'üßÄ', description: 'Savory combo platter' },
        { name: 'Dark Chocolate', emoji: 'üç´', description: 'Sweet antioxidant treat' },
        { name: 'Trail Mix', emoji: 'ü•ú', description: 'Energy-boosting blend' },
        { name: 'Hummus & Veggies', emoji: 'ü•ï', description: 'Healthy dipping option' },
        { name: 'String Cheese', emoji: 'üßÄ', description: 'Quick protein snack' }
    ]
};

// Store current selection
let currentDate = null;
let currentMealType = null;

// ========================================
// SHOW MEAL SUGGESTIONS MODAL
// ========================================
function showMealSuggestions(button) {
    // Get data from button attributes
    currentMealType = button.getAttribute('data-meal-type');
    currentDate = button.getAttribute('data-date');
    
    const modal = new bootstrap.Modal(document.getElementById('mealSuggestionsModal'));
    const titleElement = document.getElementById('mealTypeTitle');
    const contentElement = document.getElementById('mealSuggestionsContent');
    
    const mealTypeNames = {
        breakfast: 'Breakfast',
        lunch: 'Lunch',
        dinner: 'Dinner',
        midnight_snack: 'Midnight Snack'
    };
    
    titleElement.textContent = mealTypeNames[currentMealType] || 'Meal';
    
    const suggestions = mealSuggestions[currentMealType] || [];
    
    let html = '<div class="row g-3">';
    
    suggestions.forEach((meal) => {
        const escapedName = meal.name.replace(/'/g, "\\'");
        html += `
            <div class="col-md-6">
                <div class="card meal-suggestion-card h-100" 
                     onclick="selectMealSuggestion('${escapedName}')"
                     style="box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-start">
                            <div class="suggestion-emoji me-3">
                                ${meal.emoji}
                            </div>
                            <div class="suggestion-content">
                                <h6 class="mb-1 fw-bold" style="color: var(--dark-green);">
                                    ${meal.name}
                                </h6>
                                <p class="text-muted small mb-0">
                                    ${meal.description}
                                </p>
                            </div>
                            <div class="ms-2">
                                <i class="fas fa-plus-circle text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    html += `
        <div class="alert alert-info mt-4 mb-0">
            <i class="fas fa-info-circle"></i> 
            <strong>How to use:</strong> Click any suggestion to automatically fill it into the custom meal field.
        </div>
    `;
    
    contentElement.innerHTML = html;
    modal.show();
}

// ========================================
// SELECT MEAL SUGGESTION
// ========================================
function selectMealSuggestion(mealName) {
    if (!currentDate || !currentMealType) {
        alert('Error: Missing date or meal type information.');
        return;
    }
    
    // Build the field name that matches the manual rendering format
    const fieldName = currentDate + '_' + currentMealType + '-custom_meal';
    const customMealInput = document.querySelector('input[name="' + fieldName + '"]');
    
    if (customMealInput) {
        customMealInput.value = mealName;
        
        // Close modal
        const modalElement = document.getElementById('mealSuggestionsModal');
        const modal = bootstrap.Modal.getInstance(modalElement);
        modal.hide();
        
        // Show success notification
        showSuccessNotification(mealName);
        
        // Highlight the input briefly
        customMealInput.style.background = '#d4edda';
        setTimeout(function() {
            customMealInput.style.background = '';
        }, 2000);
    } else {
        console.error('Could not find input field with name:', fieldName);
        alert('Error: Could not find the input field.');
    }
}

// ========================================
// SHOW SUCCESS NOTIFICATION
// ========================================
function showSuccessNotification(mealName) {
    const notification = document.createElement('div');
    notification.className = 'alert alert-success position-fixed';
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); animation: slideInRight 0.3s ease-out;';
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-check-circle me-2" style="font-size: 1.5rem;"></i>
            <div>
                <strong>Added!</strong><br>
                <small>"${mealName}" added to custom meal</small>
            </div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(function() {
        notification.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(function() {
            notification.remove();
        }, 300);
    }, 3000);
}

// Add animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);

// ========================================
// DELETE FUNCTIONS
// ========================================
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function deleteMeal(date, mealType) {
    if (!confirm('Delete this meal?')) {
        return;
    }
    
    const csrftoken = getCookie('csrftoken');
    const url = `/weekly-plan/delete-meal/${date}/${mealType}/`;
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
        },
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        } else {
            window.location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting meal. Please try again.');
    });
}

function deleteDayMeals(date) {
    if (!confirm('Delete all meals for this day?')) {
        return;
    }
    
    const csrftoken = getCookie('csrftoken');
    const url = `/weekly-plan/delete-day/${date}/`;
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
        },
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        } else {
            window.location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting meals. Please try again.');
    });
}
</script>